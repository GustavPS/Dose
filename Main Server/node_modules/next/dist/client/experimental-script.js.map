{"version":3,"sources":["../../client/experimental-script.tsx"],"names":["ScriptCache","Map","LoadCache","Set","ignoreProps","loadScript","props","src","id","onLoad","dangerouslySetInnerHTML","children","onError","cacheKey","has","add","get","then","el","document","createElement","loadPromise","Promise","resolve","reject","addEventListener","call","set","innerHTML","__html","textContent","Array","isArray","join","k","value","Object","entries","undefined","includes","attr","DOMAttributeNames","toLowerCase","setAttribute","body","appendChild","handleClientScriptLoad","strategy","window","loadLazyScript","readyState","initScriptLoader","scriptLoaderItems","forEach","Script","preload","restProps","updateScripts","scripts","HeadManagerContext","process","env","__NEXT_SCRIPT_LOADER","syncProps","defer","concat","eager"],"mappings":"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","sourcesContent":["import React, { useEffect, useContext } from 'react'\nimport { ScriptHTMLAttributes } from 'react'\nimport { HeadManagerContext } from '../next-server/lib/head-manager-context'\nimport { DOMAttributeNames } from './head-manager'\nimport { requestIdleCallback } from './request-idle-callback'\n\nconst ScriptCache = new Map()\nconst LoadCache = new Set()\n\nexport interface Props extends ScriptHTMLAttributes<HTMLScriptElement> {\n  strategy?: 'defer' | 'lazy' | 'dangerouslyBlockRendering' | 'eager'\n  id?: string\n  onLoad?: () => void\n  onError?: () => void\n  children?: React.ReactNode\n  preload?: boolean\n}\n\nconst ignoreProps = [\n  'onLoad',\n  'dangerouslySetInnerHTML',\n  'children',\n  'onError',\n  'strategy',\n  'preload',\n]\n\nconst loadScript = (props: Props): void => {\n  const {\n    src,\n    id,\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    onError,\n  } = props\n\n  const cacheKey = id || src\n  if (ScriptCache.has(src)) {\n    if (!LoadCache.has(cacheKey)) {\n      LoadCache.add(cacheKey)\n      // Execute onLoad since the script loading has begun\n      ScriptCache.get(src).then(onLoad, onError)\n    }\n    return\n  }\n\n  const el = document.createElement('script')\n\n  const loadPromise = new Promise((resolve, reject) => {\n    el.addEventListener('load', function () {\n      resolve()\n      if (onLoad) {\n        onLoad.call(this)\n      }\n    })\n    el.addEventListener('error', function () {\n      reject()\n      if (onError) {\n        onError()\n      }\n    })\n  })\n\n  if (src) {\n    ScriptCache.set(src, loadPromise)\n    LoadCache.add(cacheKey)\n  }\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || ''\n  } else if (children) {\n    el.textContent =\n      typeof children === 'string'\n        ? children\n        : Array.isArray(children)\n        ? children.join('')\n        : ''\n  } else if (src) {\n    el.src = src\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined || ignoreProps.includes(k)) {\n      continue\n    }\n\n    const attr = DOMAttributeNames[k] || k.toLowerCase()\n    el.setAttribute(attr, value)\n  }\n\n  document.body.appendChild(el)\n}\n\nfunction handleClientScriptLoad(props: Props) {\n  const { strategy = 'defer' } = props\n  if (strategy === 'defer') {\n    loadScript(props)\n  } else if (strategy === 'lazy') {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nfunction loadLazyScript(props: Props) {\n  if (document.readyState === 'complete') {\n    requestIdleCallback(() => loadScript(props))\n  } else {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nexport function initScriptLoader(scriptLoaderItems: Props[]) {\n  scriptLoaderItems.forEach(handleClientScriptLoad)\n}\n\nfunction Script(props: Props): JSX.Element | null {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    strategy = 'defer',\n    onError,\n    preload = false,\n    ...restProps\n  } = props\n\n  // Context is available only during SSR\n  const { updateScripts, scripts } = useContext(HeadManagerContext)\n\n  useEffect(() => {\n    if (strategy === 'defer') {\n      loadScript(props)\n    } else if (strategy === 'lazy') {\n      loadLazyScript(props)\n    }\n  }, [props, strategy])\n\n  if (!process.env.__NEXT_SCRIPT_LOADER) {\n    return null\n  }\n\n  if (strategy === 'dangerouslyBlockRendering') {\n    const syncProps: Props = { ...restProps }\n\n    for (const [k, value] of Object.entries({\n      src,\n      onLoad,\n      onError,\n      dangerouslySetInnerHTML,\n      children,\n    })) {\n      if (!value) {\n        continue\n      }\n      if (k === 'children') {\n        syncProps.dangerouslySetInnerHTML = {\n          __html:\n            typeof value === 'string'\n              ? value\n              : Array.isArray(value)\n              ? value.join('')\n              : '',\n        }\n      } else {\n        ;(syncProps as any)[k] = value\n      }\n    }\n\n    return <script {...syncProps} />\n  } else if (strategy === 'defer') {\n    if (updateScripts && preload) {\n      scripts.defer = (scripts.defer || []).concat([src])\n      updateScripts(scripts)\n    }\n  } else if (strategy === 'eager') {\n    if (updateScripts) {\n      scripts.eager = (scripts.eager || []).concat([\n        {\n          src,\n          onLoad,\n          onError,\n          ...restProps,\n        },\n      ])\n      updateScripts(scripts)\n    }\n  }\n\n  return null\n}\n\nexport default Script\n"]}